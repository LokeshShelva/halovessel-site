---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import TableOfContents from '../components/TableOfContents.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	article?: boolean;
	headings?: Array<{ depth: number; slug: string; text: string }>;
};

const { title, description, pubDate, updatedDate, tags = [], article = false, headings = [] } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
	</head>
	<body>
		<Header />
		<main class={article ? 'main-article' : ''}>
			{article ? (
				<div class="post-layout">
					<article class="prose">
						<nav class="breadcrumb">
							<a href="/">~</a>
							<span class="sep">/</span>
							<a href="/blog/">blog</a>
							<span class="sep">/</span>
							<span>{title.toLowerCase().slice(0, 30)}</span>
						</nav>

						<header class="post-header">
							<h1>{title}</h1>
							<div class="post-meta">
								<span class="meta-date">
									<FormattedDate date={pubDate} />
								</span>
								{updatedDate && (
									<span class="meta-updated">
										Updated: <FormattedDate date={updatedDate} />
									</span>
								)}
							</div>
							{tags.length > 0 && (
								<div class="post-tags">
									{tags.map((t: string) => (
										<span class="tag">{t}</span>
									))}
								</div>
							)}
						</header>

						<div class="post-content">
							<slot />
						</div>
					</article>
					<aside class="toc-sidebar">
						<TableOfContents headings={headings} />
					</aside>
				</div>
			) : (
				<article class="prose">
					<nav class="breadcrumb">
						<a href="/">~</a>
						<span class="sep">/</span>
						<a href="/blog/">blog</a>
						<span class="sep">/</span>
						<span>{title.toLowerCase().slice(0, 30)}</span>
					</nav>

					<header class="post-header">
						<h1>{title}</h1>
						<div class="post-meta">
							<span class="meta-date">
								<FormattedDate date={pubDate} />
							</span>
							{updatedDate && (
								<span class="meta-updated">
									Updated: <FormattedDate date={updatedDate} />
								</span>
							)}
						</div>
						{tags.length > 0 && (
							<div class="post-tags">
								{tags.map((t: string) => (
									<span class="tag">{t}</span>
								))}
							</div>
						)}
					</header>

					<div class="post-content">
						<slot />
					</div>
				</article>
			)}
		</main>
		<Footer />
	</body>
</html>

<style>
	.main-article {
		max-width: calc(var(--max-width) + 220px + 3rem);
	}

	.post-layout {
		display: grid;
		grid-template-columns: 1fr 220px;
		gap: 3rem;
	}

	.toc-sidebar {
		padding-top: 0;
	}

	@media (max-width: 1200px) {
		.main-article {
			max-width: var(--max-width);
		}

		.post-layout {
			grid-template-columns: 1fr;
		}

		.toc-sidebar {
			display: none;
		}
	}

	.post-header {
		margin-bottom: 2.5rem;
		padding-bottom: 1.5rem;
		border-bottom: 1px solid var(--border);
	}

	.post-header h1 {
		font-size: 1.75rem;
		color: var(--fg);
		margin-bottom: 0.75rem;
		line-height: 1.3;
	}

	.post-meta {
		display: flex;
		align-items: center;
		gap: 1rem;
		font-family: var(--mono);
		font-size: 0.75rem;
		color: var(--fg-dim);
		margin-bottom: 0.75rem;
	}

	.post-tags {
		display: flex;
		gap: 0.4rem;
	}

	.post-content {
		font-size: 0.95rem;
		line-height: 1.85;
		color: var(--fg-muted);
	}

	.post-content :global(h2) {
		margin-top: 2.5em;
		margin-bottom: 0.75em;
		color: var(--fg);
	}

	.post-content :global(h3) {
		margin-top: 2em;
		margin-bottom: 0.75em;
		color: var(--fg);
	}

	.post-content :global(a) {
		color: var(--accent);
		text-decoration: underline;
		text-underline-offset: 3px;
		text-decoration-color: var(--border);
	}

	.post-content :global(a:hover) {
		text-decoration-color: var(--accent);
	}

	.post-content :global(ul),
	.post-content :global(ol) {
		margin-bottom: 1.5em;
	}

	.post-content :global(li) {
		margin-bottom: 0.5em;
	}

	.post-content :global(blockquote) {
		border-left: 2px solid var(--accent);
		margin: 1.5em 0;
		padding: 0 0 0 1em;
		color: var(--fg-muted);
	}

	.post-content :global(img) {
		margin: 2em 0;
		border-radius: var(--radius);
	}
</style>
